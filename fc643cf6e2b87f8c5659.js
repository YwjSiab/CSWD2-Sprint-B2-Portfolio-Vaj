import{sanitizeInput}from"./security.js";import{Project}from"./project.js";const contactForm=document.getElementById("contactForm");function showError(e,t,o){try{t&&(t.innerText=e,t.style.display="block"),o&&(o.style.display="none"),console.error(`Error: ${e}`)}catch(e){console.error("showError failed:",e)}}function clearError(e){try{e&&(e.innerText="",e.style.display="none")}catch(e){console.error("clearError failed:",e)}}function showSuccess(e,t){try{t&&(t.innerText=e,t.style.display="block",console.log(`Success: ${e}`),setTimeout(()=>{try{t.style.display="none"}catch(e){console.error("Error hiding success message:",e)}},3e3))}catch(e){console.error("showSuccess failed:",e)}}function createLabel(e,t){const o=document.createElement("label");return o.setAttribute("for",e),o.textContent=t,o}function createInput(e,t,o=!1,r="",n=""){const c=document.createElement("input");return c.type=e,c.id=t,o&&(c.required=!0),r&&(c.placeholder=r),n&&(c.accept=n),c}function createInputGroup(e,t,o="text",r=""){const n=document.createElement("div");return n.className="input-group",n.appendChild(createLabel(e,t)),n.appendChild(createInput(o,e,!0,r)),n}contactForm?contactForm.addEventListener("submit",e=>{try{e.preventDefault();const t=sanitizeInput(document.getElementById("name").value),o=sanitizeInput(document.getElementById("email").value),r=sanitizeInput(document.getElementById("message").value),n=document.getElementById("formError"),c=document.getElementById("formSuccess"),s=document.getElementById("photoDataUrl")?.value||"",a=document.querySelector("input[name='csrfToken']")?.value,l=sessionStorage.getItem("csrfToken");if(!t||!o||!r)return void(document.getElementById("formError").innerText="Please fill out all fields.");if(!a||a!==l)return void alert("CSRF token mismatch. Submission blocked.");const i=e=>{n&&(n.innerText=e,n.style.display="block"),c&&(c.innerText="",c.style.display="none")},d=/\b(SELECT|INSERT|UPDATE|DELETE|DROP|TRUNCATE|--)\b/i;if(d.test(t)||d.test(r))return void i("SQL keywords are not allowed in title or message.",n,c);if(!t||!/^[A-Za-z\s]+$/.test(t))return console.error("Error: Name must contain only letters and spaces."),void i("Name can only contain letters and spaces.");if(!o||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o))return console.error("Error: Invalid email format"),void i("Please enter a valid email address.");if(!r||r.length<10)return console.error("Error: Message must be at least 10 characters."),void i("Message must be at least 10 characters long.");n&&(n.innerText="");const m=sessionStorage.getItem("lastContactSubmit"),u=Date.now();if(m&&u-m<3e4)return console.warn("You must wait before submitting again."),void(document.getElementById("formError").innerText="Please wait before submitting again.");sessionStorage.setItem("lastContactSubmit",u.toString()),console.log("Form submitted successfully:",{name:t,email:o,message:r,photo:s}),c&&(c.innerText="Your message has been sent!",c.style.display="block"),n&&(n.innerText="",n.style.display="none"),contactForm.reset()}catch(e){console.error("Error handling contact form submission:",e)}}):console.warn("No 'contactForm' found on this page. Skipping form event listener.");const handleFormSubmission=async e=>{try{e.preventDefault();const t=document.getElementById("formError"),o=document.getElementById("formSuccess"),r=document.getElementById("title")?.value.trim(),n=document.getElementById("category")?.value;let c=document.getElementById("description")?.value.trim(),s=document.getElementById("technologies")?.value.trim();const a=document.getElementById("projectLink")?.value.trim(),l=document.getElementById("projectImage")?.files[0];s=s?s.split(",").map(e=>e.trim()):[];try{if(!(r&&c&&s.length&&a))return void showError("All fields are required!",t,o);const e=/\b(SELECT|INSERT|UPDATE|DELETE|DROP|TRUNCATE|--)\b/i;if(e.test(r)||e.test(c))return void showError("SQL keywords are not allowed in title or description.",t,o);if(!c||c.length<10)return void showError("Project description must be at least 10 characters long!",t,o);if(!/^(https?:\/\/)?([\w\d\-_]+\.+[A-Za-z]{2,})+\/?/.test(a))return void showError("Enter a valid project URL!",t,o)}catch(e){return console.error("Validation error:",e),void showError("An error occurred during validation.",t,o)}console.log("Attempting to add new project..."),console.log("Title:",r),console.log("Category:",n),console.log("Description:",c),console.log("Technologies Used:",s),console.log("Project Link:",a),console.log("Image File:",l?l.name:"No Image Uploaded");let i="";try{if(l){if(!["image/png","image/jpeg"].includes(l.type))return void showError("Only PNG and JPEG images are allowed!",t,o);i=URL.createObjectURL(l)}}catch(e){return console.error("Error handling image file:",e),void showError("Error processing image upload.",t,o)}try{clearError(t);const e=new Project((window.allProjects?.length||0)+1,r,c,s,n,i);Array.isArray(window.allProjects)&&window.allProjects.push(e);try{let t=localStorage.getItem("projects"),o=t?JSON.parse(t):[];o.push(e),localStorage.setItem("projects",JSON.stringify(o)),console.log("✅ Project saved to localStorage.")}catch(e){console.error("❌ Failed to save project to localStorage:",e),showError("An error occurred while saving your project locally. Please try again.",t,o)}const a=document.getElementById("filterDropdown"),l=a?a.value:"All";"function"==typeof window.filterProjects&&window.filterProjects(l),showSuccess("Project added successfully!",o),document.getElementById("projectForm").reset(),console.log("Project successfully added:",e)}catch(e){console.error("Error creating or displaying project:",e),showError("An error occurred while adding the project.",t,o)}}catch(e){console.error("Unexpected error in form submission:",e),showError("Unexpected error occurred. Please try again.",document.getElementById("formError"),document.getElementById("formSuccess"))}},addProjectForm=()=>{try{const e=document.getElementById("projectSubmission");if(!e)return void console.warn("⚠️ No 'projectSubmission' container found. Skipping form creation.");if(document.getElementById("projectForm"))return void console.warn("Project form already exists. Skipping form creation.");const t=document.createElement("form");t.id="projectForm";try{t.appendChild(createLabel("title","Project Title:")),t.appendChild(createInput("text","title",!0)),t.appendChild(createLabel("description","Project Description:"));const o=document.createElement("textarea");o.id="description",o.required=!0,t.appendChild(o);const r=document.createElement("div");r.className="form-flex-container";const n=document.createElement("div");n.className="input-group",n.appendChild(createLabel("category","Project Category:"));const c=document.createElement("select");c.id="category",c.required=!0,["Web Development","UI/UX Design","Responsive Design"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,c.appendChild(t)}),n.appendChild(c),r.appendChild(n),r.appendChild(createInputGroup("technologies","Technologies Used (comma-separated):")),r.appendChild(createInputGroup("projectLink","Project Link:","url","https://example.com")),t.appendChild(r);const s=document.createElement("div");s.className="file-upload-container",s.appendChild(createLabel("projectImage","Upload Image:")),s.appendChild(createInput("file","projectImage",!1,"","image/png, image/jpeg")),t.appendChild(s);const a=document.createElement("button");a.type="submit",a.textContent="Add Project",t.appendChild(a),e.appendChild(t),t.addEventListener("submit",handleFormSubmission)}catch(t){console.error("Error building form elements:",t),e.innerText="An error occurred while building the form."}}catch(e){console.error("Error creating project submission form:",e)}};export{addProjectForm};